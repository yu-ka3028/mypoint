# mypoint 設計書

## サービス概要

ポイントカードのような達成感で日常タスクを管理するアプリ。
ご褒美を設定してポイントを貯める過程のワクワク感を体験することが主軸。

**ターゲット**: 個人利用中心（最大20ユーザー）
**コスト**: 無料枠のみ（Supabase / Vercel）

---

## 技術スタック

| カテゴリ | 技術 |
|---------|------|
| フレームワーク | Next.js (App Router) |
| 言語 | TypeScript |
| スタイリング | TailwindCSS + shadcn/ui |
| 状態管理 | useState / useEffect |
| テスト | Vitest |
| Linter / Formatter | Biome |
| DB / Auth | Supabase (PostgreSQL + Google OAuth) |
| デプロイ | Vercel |

**選定理由**:
- Java/Vue の業務技術縛りより「AIとの協働体験」を優先
- エコシステムが大きい技術を選択（Claude Codeとの相性）
- 将来の React 移行を見据えたアーキテクチャ

---

## アーキテクチャ方針

### フロントエンド構成

```
src/
├── app/           # Next.js ページ・ルート
├── components/
│   ├── ui/        # shadcn/ui コンポーネント
│   ├── point-card/ # ポイントカードUI
│   └── landing/   # ランディングページ用
├── core/          # フレームワーク非依存のビジネスロジック（将来のReact移行に備える）
├── hooks/         # React Hooks
├── lib/           # Supabaseクライアント・ユーティリティ
└── types/         # 型定義
```

### React移行を見据えた設計

- ビジネスロジックは `core/` に集約しフレームワーク非依存で実装
- Composables → Custom Hooks は概念的に近く移行コストが低い
- Supabase クライアントコードはフレームワークに依存しない

---

## 認証

- **方式**: Google OAuth のみ（Supabase Auth）
- **実装**: `@supabase/ssr` を使用（Next.js App Router 対応）
- **セッション管理**: `proxy.ts`（Next.js 16 のミドルウェア）でセッション更新・認証ガード

---

## データベース設計

### テーブル構成

| テーブル | 公開範囲 | 用途 |
|---------|---------|------|
| `user_profiles` | **全員が読める** | 表示名・ポイント集計（今日/今週/累計） |
| `tasks` | 本人のみ | タスクマスター |
| `task_completions` | 本人のみ | 完了履歴・ポイント計算元データ |
| `daily_routine_status` | 本人のみ | 毎日ルーティンの状態 |
| `weekly_routine_status` | 本人のみ | 毎週ルーティンの状態 |
| `rewards` | is_public=trueのみ全員・それ以外は本人 | ご褒美設定 |

### タスクの種類とポイント配分ルール

| type | 説明 | ポイント決定方法 |
|------|------|----------------|
| `daily_routine` | 毎日ルーティン | **100pt ÷ 登録タスク数**（自動均等配分） |
| `weekly_routine` | 毎週ルーティン | **100pt ÷ 登録タスク数**（自動均等配分） |
| `urgent` | 突発緊急 | **ユーザー指定**（任意のpt） |
| `someday` | 突発いつかやる | **ユーザー指定**（任意のpt） |

**例**:
- 毎日ルーティンを5個登録 → 各20pt（合計100pt）
- 毎週ルーティンを4個登録 → 各25pt（合計100pt）
- 突発タスク「確定申告」→ ユーザーが30ptと設定

タスク数が変わった時点で均等配分を再計算する。

### ポイント計算

```
今日の合計 = 完了した毎日ルーティン合計 + 今日完了した突発タスク合計
今週の合計 = 完了した毎週ルーティン合計 + 今週完了した突発タスク合計
```

**1日の獲得ポイントの考え方**:
- ベース: 最大100pt（毎日ルーティン全完了）
- ボーナス: 突発タスク完了分（ユーザー設定による）
- 平均的な1日 ≒ 100pt → 1マス25pt = 1日で約4マス進む設計

`user_profiles` の `points_today` / `points_this_week` / `points_total` はタスク完了時に更新。
公開ランキングはここから取得（task_completions はプライベートのため直接見せない）。

### 毎日リセット（遅延生成方式）

cron は使わず、アプリ起動時 + Page Visibility API の復帰時にチェック。

```
今日のJST日付 == lastCheckedDate？
  Yes → 何もしない（メモリ比較のみ、コスト無し）
  No  → Supabaseに今日分のルーティンレコードを生成
```

**タイムゾーン**: JST固定（`Asia/Tokyo`）
**日付保存形式**: JST基準の `YYYY-MM-DD` 文字列

---

## ポイントカードUI

### マス設計

```
定数:
  COLS            = 8     横マス数（固定）
  PTS_PER_SQUARE  = 25    1マス = 25pt
  PTS_PER_ROW     = 200   1行 = 8 × 25pt

カードの行数 = ceil(最大ご褒美pt / PTS_PER_ROW)
埋まったマス数 = floor(現在ポイント / PTS_PER_SQUARE)
```

### 表示イメージ

```
現在 250pt / ご褒美: ケーキ(200pt)・映画(500pt)・旅行(10000pt)

[■][■][■][■][■][■][■][■]  row1 (0〜200pt)
🎂 ケーキ達成! ──────────────── ← マイルストーン
[■][■][□][□][□][□][□][□]  row2 (200〜400pt)
[□][□][□][□][□][□][□][□]  row3 (400〜600pt)
🎬 映画 ──────────────────────  ← マイルストーン（未達）
...（旅行まで縦に続く）
```

ご褒美未設定時: デフォルト maxRewardPoints = 500pt

---

## ページ構成

### ランディングページ `/`（未ログインでも表示）

1. ヒーローセクション（タイトル・タグライン）
2. ポイントカード アニメーションデモ（サンプルデータで自動アニメーション）
3. ランキング（user_profiles の points_total 降順 上位5名）
4. Google ログインCTA

### ホーム `/`（ログイン済み）

- 実ポイントデータのポイントカード
- タスク一覧（今後実装）

---

## 実装フェーズ

### Phase 1（完了）
- [x] プロジェクトセットアップ
- [x] Supabase DBスキーマ・RLS
- [x] Google認証

### Phase 2（実装中）
- [ ] ランディングページ + ポイントカードUI

### Phase 3
- [ ] タスクCRUD（作成・一覧・完了）
- [ ] ルーティン自動生成（遅延生成）
- [ ] ポイント計算・user_profiles更新

### Phase 4
- [ ] タスク完了時のスタンプ演出
- [ ] レスポンシブデザイン調整
- [ ] Vercel デプロイ

### Phase 5（将来）
- [ ] ご褒美設定・達成通知
- [ ] 統計・グラフ
